@using Thermory.Domain.Enums
@model Thermory.Web.Models.OrderForm
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var firstCategoryId = Model.LumberOrderForms.First().LumberCategory.Id;
    var action = Model.Order.Id == Guid.Empty ? "Create" : "Edit";
    var orderType = Model.OrderType == OrderTypes.PurchaseOrder ? "Purchase" : "Sales";
    var orderNumber = Model.Order.Id == Guid.Empty ? "" : Model.Order.OrderNumberString;
    var title = string.Format("{0} {1} Order {2}", action, orderType, orderNumber);
    var orderId = Model.Order == null ? Guid.Empty : Model.Order.Id;
}

<h3><strong>@title</strong></h3>
<br/>
<div id="worksheetPanel">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">Customer</h3>
        </div>
        <div class="panel-body">
            <div class="form-group">
                <select id="customerId" onchange="customerChanged();">
                    <option value="@Guid.Empty" selected="selected">Add New</option>
                    @foreach (var customer in Model.Customers)
                    {
                        var selected = customer.Id == Model.Order.CustomerId ? " selected=\"selected\"" : "";
                        <option value="@customer.Id"@selected>@customer.Name</option>
                    }
                </select>
            </div>
            <div class="form-group">
                <label for="customerName">Name</label>
                <input type="text" id="customerName" class="form-control" />
            </div>
        </div>
    </div>
    <button type="button" onclick=" saveOrder();">Save</button>
    <br />
    <br />
    <ul class="nav nav-tabs" data-tabs="tabs">
        @{
            foreach (var orderForm in Model.LumberOrderForms)
            {
                var category = orderForm.LumberCategory;
                var active = category.Id == firstCategoryId ? "class=active" : "";
                <li @active><a href="#@orderForm.LumberCategory.Id" data-toggle="tab">@category.Name</a></li>
            }
            foreach (var category in Model.MiscellaneousOrderForms.Select(orderForm => orderForm.MiscellaneousCategory))
            {
                <li><a href="#@category.Id" data-toggle="tab">@category.Name</a></li>
            }
        }
    </ul>
    <div class="tab-content">
        @{
            foreach (var orderForm in Model.LumberOrderForms)
            {
                var category = orderForm.LumberCategory;
                var active = category.Id == firstCategoryId ? "active" : "";
                <div id="@category.Id" class="tab-pane @active">
                    @Html.Partial("_LumberLineItemForm", orderForm)
                </div>
            }
            foreach (var orderForm in Model.MiscellaneousOrderForms)
            {
                var category = orderForm.MiscellaneousCategory;
                <div id="@category.Id" class="tab-pane">
                    @Html.Partial("_MiscellaneousLineItemForm", orderForm)
                </div>
            }
        }
    </div>
    <button type="button" onclick=" saveOrder();">Save</button>
</div>

<div id="savingPanel" style="display: none;">Saving...</div>

<script type="text/javascript">
    $(document).ready(function () {
        $('input[name=lumberQty],[name=miscQty]').keydown(function (e) {
            // Allow: backspace, delete, tab, escape, enter and .
            if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
                // Allow: Ctrl+A, Command+A
                (e.keyCode == 65 && (e.ctrlKey === true || e.metaKey === true)) ||
                // Allow: home, end, left, right, down, up
                (e.keyCode >= 35 && e.keyCode <= 40)) {
                // let it happen, don't do anything
                return;
            }
            // Ensure that it is a number and stop the keypress
            if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                e.preventDefault();
            }
        });
        customerChanged();
    });

    function customerChanged() {
        console.log('customerChanged');
        var selectedCustomer = $('#customerId option:selected');

        var customerName = selectedCustomer.val() == '@Guid.Empty' ? '' : selectedCustomer.text();
        $('#customerName').val(customerName);
    }

    function saveOrder() {
        var lumberProducts = getInventory('lumber');
        var miscProducts = getInventory('misc');

        if (lumberProducts.length == 0 && miscProducts == 0) {
            return;
        }

        $('#worksheetPanel').hide();
        $('#savingPanel').show();

        var customer = getCustomer();
        var customerJson = JSON.stringify(customer);
        var lumberJson = JSON.stringify(lumberProducts);
        var miscJson = JSON.stringify(miscProducts);

        var postData = '{"orderType" : "@Model.OrderType", "orderId" : "@orderId", "customer" : ' + customerJson + ', "lumberOrderQuantities" : ' + lumberJson + ', "miscOrderQuantities" : ' + miscJson + '}';

        console.log(lumberJson);
        console.log(miscJson);
        console.log(postData);

        $('#worksheetPanel').show();
        $('#savingPanel').hide();
        $.ajax({
            type: 'POST',
            url: '@Url.Action("SaveOrder", "Order")',
            contentType: 'application/json',
            dataType: 'json',
            data: postData,
            success: function (data, status, request) {
                window.location = ('@Url.Action("Index", "Order")');
            },
            error: function (data, status, request) {
                console.log(data);
                console.log(status);
                console.log(request);
                $('#worksheetPanel').show();
                $('#savingPanel').hide();
            }
        });
    }

    function getCustomer() {
        return {
            Id: $('#customerId').val(),
            Name: $('#customerName').val()
        };
    }

    function getInventory(prefix) {
        var products = new Array();
        var query = 'input[name=\'' + prefix + 'Qty\']';
        $(query).each(function () {
            var id = $(this).attr('id');
            var productId = $(this).attr('productId');
            var qty = $(this).val();

            if (qty > 0) {
                products.push(createProductLineItem(id, productId, qty));
            }
        });
        return products;
    }

    function createProductLineItem(id, productId, qty) {
        return {
            Id: id,
            ProductId: productId,
            Quantity: qty
        };
    }
</script>